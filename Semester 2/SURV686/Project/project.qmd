---
title: "Project"
author: "Sagnik Chakravarty"
format:
  pdf:
    latex_engine: xelatex
header-includes:
  - \usepackage[a4paper, margin=0.5in]{geometry}
toc: FALSE
lot: FALSE
editor: visual
---

```{r warning=FALSE, message=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(tidyverse)
library(car)
library(ResourceSelection)
library(pROC)
library(caret)
library(MASS)
library(pacman)
data <- read_csv(file = 'chd.csv')
data$famhist<- factor(data$famhist,
                      levels = c("Absent", "Present"),
                      labels = c(0, 1))
data$chd <- factor(data$chd)
kable(head(data), format = 'latex')
str(data)
```

# EDA

```{r}
# CHD prevalence
kable(table(data$chd), format = 'latex')
kable(prop.table(table(data$chd)), format = 'latex')

# Continuous variables summary
continuous_vars <- c("sbp", 
                     "tobacco", 
                     "ldl", 
                     "adiposity", 
                     "obesity", 
                     "alcohol", 
                     "age", 
                     "typea")
kable(sapply(data[continuous_vars], 
             function(x) c(Mean = mean(x), 
                           SD = sd(x), 
                           Min = min(x), 
                           Max = max(x))),
      format = 'latex')

# Categorical variable summary
kable(table(data$famhist), format = 'latex')

# Bivariate relationships
# Empirical logit plots for continuous variables
ggplot(data, aes(x = tobacco, y = as.numeric(chd)-1)) + 
  geom_smooth(method = "loess") +
  labs(title = "Empirical Logit Plot: Tobacco vs CHD")

ggplot(data, aes(x = ldl, y = as.numeric(chd)-1)) + 
  geom_smooth(method = "loess") +
  labs(title = "Empirical Logit Plot: LDL vs CHD")
```

```{r}
# Full logistic regression model
full_model <- glm(chd ~ sbp + tobacco + ldl + adiposity + famhist + 
                  typea + obesity + alcohol + age,
                family = binomial(link = "logit"), data = data)

# Model summary
summary(full_model)

# Likelihood ratio test
null_model <- glm(chd ~ 1, family = binomial, data = data)
lmtest::lrtest(null_model, full_model)

# McFadden's pseudo R-squared
1 - (logLik(full_model)/logLik(null_model))

# Stepwise model selection
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)

# Final model (based on analysis in report)
final_model <- full_model
```

```{r}
# Variance Inflation Factors (check multicollinearity)
vif(final_model)

# Hosmer-Lemeshow test
hoslem.test(final_model$y, fitted(final_model), g = 10)

# Residual analysis
par(mfrow = c(2,2))
plot(final_model, which = 1:4)
par(mfrow = c(1,1))
```

```{r}
##############################
# Predictive Accuracy Assessment #
##############################

# Predicted probabilities
data$pred_prob <- predict(final_model, type = "response")

# Confusion matrix (0.5 cutoff)
# Convert both vectors to factors with EXPLICIT LEVELS
predicted <- factor(ifelse(data$pred_prob > 0.5, "Yes", "No"), 
                   levels = c("No", "Yes"))
actual <- factor(data$chd, levels = c("No", "Yes"))

# Create confusion matrix with aligned factors
conf_mat <- confusionMatrix(predicted, actual)

# ROC curve analysis
roc_obj <- roc(data$chd, data$pred_prob)
plot(roc_obj, main = "ROC Curve")
auc(roc_obj)

# Optimal cutoff using Youden's index
coords(roc_obj, "best", best.method = "youden")
```

```{r}
########################
# Results Interpretation #
########################

# Odds ratios and CI
odds_ratios <- exp(coef(final_model))
ci <- exp(confint(final_model))

results_table <- data.frame(
  Predictor = names(odds_ratios),
  OR = round(odds_ratios, 3),
  CI_Lower = round(ci[,1], 3),
  CI_Upper = round(ci[,2], 3)
)

print(results_table)

# Clinical interpretation
cat("Key Interpretation:\n")
cat("- Each additional cigarette/day increases CHD odds by", round(100*(results_table["tobacco","OR"]-1),1),"%\n")
cat("- Each unit increase in LDL increases CHD odds by", round(100*(results_table["ldl","OR"]-1),1),"%\n")
cat("- Family history increases CHD odds by", round(results_table["famhistYes","OR"],1), "times\n")

########################
# Visualization Code #
########################

# Coefficient plot
coef_plot <- data.frame(Predictor = names(coef(final_model))[-1],
                       OR = exp(coef(final_model))[-1],
                       CI_Lower = exp(confint(final_model))[-1,1],
                       CI_Upper = exp(confint(final_model))[-1,2])

ggplot(coef_plot, aes(x = OR, y = Predictor)) +
  geom_point() +
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_log10() +
  labs(title = "Odds Ratios with 95% Confidence Intervals")

# Predicted probability distribution
ggplot(data, aes(x = pred_prob, fill = chd)) +
  geom_density(alpha = 0.5) +
  labs(x = "Predicted Probability of CHD", 
       title = "Probability Distribution by CHD Status")
```
